<!doctype html>
<html>
<head>
<meta charset="utf-8">
<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!--Import materialize.css-->
<link type="text/css" rel="stylesheet" href="../css/materialize.css"  media="screen,projection"/>
<!--Let browser know website is optimized for mobile-->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link type="text/css" rel="stylesheet" href="../css/mainStylesheet.css"/>
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../js/materialize.min.js"></script>
<!--Validator-->
<script src="../Plugins/validator/jquery.validate.js"></script>
<script>
//Create Database
var createTableSQL = "CREATE TABLE IF NOT EXISTS tblSupervisor (fldLicenceNo TEXT PRIMARY KEY, fldName TEXT, fldPhoneNo TEXT);";
var insertSQL = "INSERT INTO tblSupervisor (fldLicenceNo, fldName, fldPhoneNo) VALUES (?, ?, ?);";
var showSQL = "SELECT * FROM tblSupervisor;";
var updateRecordSQL = "UPDATE tblSupervisor SET fldName=?, fldPhoneNo=? WHERE fldLicenceNo = ?;";
var deleteSQL = "DELETE from tblSupervisor WHERE fldLicenceNo=?;";
var	deleteAllSQL = "DELETE from tblSupervisor";
var dropTable = "DROP TABLE tblSupervisor";
var db = null;
//Database
$(document).ready(function() {
  document.addEventListener("deviceready", onDeviceReady(), false);
//NavBar
    $('.sidenav').sidenav();
	//Floating button +
	$('.fixed-action-btn').floatingActionButton();
	//Tooltip
	$('.tooltipped').tooltip();
	//modal
	$('.modal').modal();
  	
	//$("#modal2").hide();

	$("#addBtn").on("click", function() {
		$("#txtName").val("");
		$("#licenceNo").val("");
		$("#phoneNo").val("");	
	});
	
  	$("#saveSupervisor").on('click', function() {
    	console.log("About to add a task");
    	insertRecord();
  });
  
  	$("#editSupervisor").on('click', function() {
		console.log("About to edit a task");
		saveRecord();
	});

	$("#deleteAll").on('click', function() {
		deleteALLRecords();
	});
});

var onDeviceReady = function() {
  console.log("In deviceready");

  try {
    if( !window.openDatabase )
      alert("This device does NOT support databases");
    else {
      var shortName = "Log Book";
      var version = "1";
      var displayName = "Log Book";
      var maxSize = 1024;
      db = window.openDatabase(shortName, version, displayName, maxSize);
      console.log("Database opened");
      db.transaction(populateDB, onError, showRecords);
    } // end else
  }
  catch(err) {
    console.log("Error: " + err);
  }
};

var populateDB = function(trans) {
  db.transaction(function(trans) {
	 trans.executeSql(createTableSQL,[]);
	 //trans.executeSql(dropTable,[]);
	  console.log("Table created");
  }); // end of transaction
};

var showRecords = function() {
  console.log("In show records");
  db.transaction(function(trans){
    trans.executeSql(showSQL,[], function(trans, result) {
      var str = "";

      if( result.rows.length == 0 ) {
        $("#licenceNoCard").html("<em>There are no records to display</em>");
		//str += "<div class='col s12 m7 cards' >";
		str += "<div class='card horizontal'>";
		str += "<div class='card-stacked'></div></div>";
        str = "<div value='0' style='text-align:center'><strong>There are no records to display</strong</div></div>";
        $("#cardSup").html(str);
      }
      else {
        var noOfRecs = result.rows.length;
        for(var i = 0; i < noOfRecs; i++) {
          // saving row to a variable
          var row = result.rows.item(i);
		  str += "<div class='col s12 m7 cards' >";
		  str += "<div class='card horizontal'>";
		  str += "<div class='card-stacked'>";
		  str += "<div class='card-content'>"
		  str += "<span class='card-title'>";
		  str += "<strong>" + row['fldName'] + "</strong></span>";
		  str += "<div class='card_icon'>";
		  str += "<i class='material-icons left'>event</i><strong>Licence Number:</strong> " + row['fldLicenceNo'] + "</div>";
		  str += "<div class='card_icon'>";
	      str += "<i class='material-icons left'>people</i><strong>Phone:</strong> " + row['fldPhoneNo'] + "</div>";
		  str += "<button data-target='modal2' onClick='editRecord(\""+ row['fldName'] + "\"," + row['fldLicenceNo'] + ",\"" + row['fldPhoneNo'] +"\");'";
		  str += "class='btn modal-trigger waves-effect waves-light red accent-2'>Edit</button>";
		  str +="<button onClick='deleteRecord(\"" + row['fldLicenceNo'] + "\");' class='btn waves-effect waves-light right red'>Delete</button></div></div></div></div>";
			
          //$("#licenceNoCard").append(str);
        }
        $("#cardSup").append(str);
        console.log("Supervisor added to card");
      } // end else
    });
  });
};

var insertRecord = function() {
  console.log("In insertRecord");

  var newName = $("#txtName").val();
  var newLicenceNo = $("#licenceNo").val();
  var newPhoneNo = $("#phoneNo").val();

  console.log( "New Supervisor: " + newName );
    db.transaction(function(trans) {
      trans.executeSql(insertSQL, [newLicenceNo, newName, newPhoneNo], onError);
    });
	location.reload();
	
	$(".msg").html(newName + " " + newLicenceNo + " " + newPhoneNo + " added");
    clearTxt();
    return true;
}

var editRecord = function(name,licenceNo,phoneNo) {
  console.log("In save task")
  console.log( "First Name: " + phoneNo );
	$("#editName").val(name);
	$("#editLicenceNo").val(licenceNo);
	$("#editPhoneNo").val(phoneNo);
	
	M.updateTextFields();
}
							
var saveRecord = function() {
	var name = $("#editName").val();
	var licenceNo = $("#editLicenceNo").val();
	var phoneNo = $("#editPhoneNo").val();
	
	db.transaction(function(trans) {
		  trans.executeSql(updateRecordSQL, [name, phoneNo, licenceNo], showRecords, onError);
	});
	location.reload();
	clearTxt();
	return true;
}

var deleteRecord = function(licenceNo)
{
	var q = confirm("Do you wish to delete this record");

	if(q) {
		db.transaction(function(trans) {
			trans.executeSql(deleteSQL, [licenceNo], onError);
		});
		$(".msg").html("Record deleted");
		location.reload();
		clearTxt();
		return true;
	} else {
		$(".msg").html("Record NOT deleted");
		clearTxt();
		return false;
	}
}

var deleteALLRecords = function()
{
	var q = confirm("Do you wish to delete ALL records?");

	if(q)
	{
		db.transaction(function(trans) {
			trans.executeSql(deleteAllSQL, [], showRecords, onError);
		});

		$(".msg").html("All records deleted");
		clearTxt();
		return true;
	}
	else
	{	$(".msg").html("All records NOT deleted");
		clearTxt();
		return false;
	}
}

/**
 *  function onError(err)
 */
var onError = function(err) {
	var str = "";
	switch(err.code)	{
		case	0:  str += "Non database error: " + err.message;
					break;
		case	1:	str += "Some database error: " + err.message;
					break;
		case	2:	str += "Wrong database version: " + err.message;
					break;
		case	3:	str += "Data set too large to return from query: " + err.message;
					break;
		case	4: 	str += "Storage limit exceeded: " + err.message;
					break;
		case	5:	str += "Lock contension error: " + err.message;
					break;
		case	6:	str += "Constraint failure: " + err.message;
					break;
		default	:	str += "Error: " + err.code + " " + err.message;
					break;
	}
	console.log(str);
}

var clearTxt = function clearTxt() {
  setTimeout(function(){$(".msg").html("");}, 1000);
}


	
</script>
<title>Profile</title>
</head>

<body>
<nav>
    <div class="nav-wrapper navbar">
      <a href="#!" class="center brand-logo">Supervisors</a>
      <a href="../index.html" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons left">arrow_back</i></a>
      <ul class="left hide-on-med-and-down">
        <li><a href="../index.html" data-target="mobile-demo"><i class="material-icons left">arrow_back</i></a></li>
      </ul>
    </div>
  </nav>
 <h2 align="center">Your Supervisor's information</h2> 
<div class="col s12 m7 cards">
<!-- Modal1 Structure -->
<div id="modal1" class="modal">
	<div class="modal-content">
			<span class="card-title">Supervisor</span>
				<div class="row">
					<form class="col s12" id="addSupervisor" method="get">
						  <div class="row">
								<div class="input-field col s12">
							  		<input id="txtName" type="text" class="validate" >
							  		<label for="txtName">Name</label>
							  		<p class="msg"></p>
								</div>
						  	</div>
							<div class="row">
								<div class="input-field col s12">
								  <input id="licenceNo" type="text" class="validate">
								  <label for="licenceNo">Licence Number</label>
								  <p class="msg"></p>
								</div>
							</div>
							<div class="row">
								<div class="input-field col s12">
									<input id="phoneNo" type="text" class="validate">
									<label for="phoneNo">Phone Number</label>
									<p class="msg"></p>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="col s12">
					<button class="waves-effect waves-light btn modalBtn" type="reset" id="resetButton">Cancel</button>
					<button class="btn waves-effect waves-light modalBtn right red accent-2" type="submit" name="action"  id="saveSupervisor">Save
						<i class="material-icons right">send</i>
					</button>
  				</div> 
			</div>
		</div>
		
<!-- Modal Edit -->
<div id="modal2" class="modal">
	<div class="modal-content">
			<span class="card-title">Supervisor</span>
				<div class="row">
					<form class="col s12" id="modalSupervisor" method="get">
						  <div class="row">
								<div class="input-field col s12">
							  		<input id="editName" type="text" class="validate" >
							  		<label for="editName">Name</label>
							  		<p class="msg"></p>
								</div>
						  	</div>
							<div class="row">
								<div class="input-field col s12">
								  <input id="editLicenceNo" type="text" class="validate">
								  <label for="editLicenceNo">Licence Number</label>
								  <p class="msg"></p>
								</div>
							</div>
							<div class="row">
								<div class="input-field col s12">
									<input id="editPhoneNo" type="text" class="validate">
									<label for="editPhoneNo">Phone Number</label>
								<p class="msg"></p>
							</div>
						</div>
					</form>
				</div>
			</div>
		<div class="col s12">
		<button class="waves-effect waves-light btn modalBtn" type="reset" id="editResetButton">Cancel</button>
		<button class="btn waves-effect waves-light modalBtn right red accent-2" type="submit" name="action"  id="editSupervisor">Save
			<i class="material-icons right">send</i>
		</button>
  	</div> 
</div>
<!--Cards -->
	<div id="cardSup">
	</div>
		<!--<div class="card horizontal">
		  <div class="card-stacked">
			<div class="card-content" id="cardSup">
			</div>
		  </div>
	   </div>-->
	<div class="col s12 m7 cards">
	   	<button data-target="modal1" id="addBtn" class="btn modal-trigger right">Add</button>
	   	<button data-target="modal1" class="btn left red" id="deleteAll">Delete All supervisors</button>
	</div>	
</body>
</html>
