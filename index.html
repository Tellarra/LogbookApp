<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>jQuery Mobile Web App</title>
<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!--Import materialize.css-->
<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
<!--Let browser know website is optimized for mobile-->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link type="text/css" rel="stylesheet" href="css/mainStylesheet.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
<!--Gauge-->
<script src="Plugins/Creating-Animated-Gauges-Using-jQuery-Raphael-js-kumaGauge/Creating-Animated-Gauges-Using-jQuery-Raphael-js-kumaGauge/demo/js/vendor/raphael-min.js"></script>
<script src="Plugins/Creating-Animated-Gauges-Using-jQuery-Raphael-js-kumaGauge/Creating-Animated-Gauges-Using-jQuery-Raphael-js-kumaGauge/kuma-gauge.jquery.js"></script>

<script>
//Select values from other tables
//var selectProfileTable = "SELECT tblProfile FROM Log Book WHERE type = 'table';";
var selectOtherTable = "SELECT * FROM Log Book WHERE type = 'table';";
var selectAllRecordProfile =  "SELECT * FROM tblProfile;";
//Insert Values
var insertSQL = "INSERT INTO tblProfile (fldLicenceNo, fldName, fldBirth, fldPermitDate, fldPhone) VALUES (?, ?, ?, ?, ?);";
	
$(document).ready(function() {
	document.addEventListener("deviceready", onDeviceReady(), false);
	
	//NavBar
    $('.sidenav').sidenav();
	//Floating button +
	$('.fixed-action-btn').floatingActionButton();
	//Tooltip
	$('.tooltipped').tooltip();
	//Modal
	$('.modal').modal();
	//DatePickers
	$('.datepicker').datepicker();
	//Save profile
	
	
	$("#saveProfile").on("click", function() {
		insertRecord();
	});
	
	db.transaction(function(trans) {
		trans.executeSql("SELECT * from tblSession;", [], function(trans, result) {
			var noOfRecs = result.rows.length;
			var allTimesDriving = 0;
			for(var i = 0; i < noOfRecs; i++) {
				var row = result.rows.item(i);
				if(row['fldDrivingTime'] != null) {
					currentTime = parseInt(row['fldDrivingTime']);
					allTimesDriving += currentTime;
					//allTime += row['fldDrivingTime'].substring(0,2);
					console.log("1 " + allTimesDriving);
				}
			}
			gaugeRecord(allTimesDriving);
			console.log("2 " + allTimesDriving);
		});
	});
	//console.log("3 " + allTimesDriving);
	
});
	
var onDeviceReady = function() {
  console.log("In deviceready");
  try {
    if( !window.openDatabase )
      alert("This device does NOT support databases");
    else {
      /*var shortName = "Sessions";
      var version = "1";
      var displayName = "Sessions";
      var maxSize = 1024;*/
      db = window.openDatabase("Log Book", "1", "Log Book", "1024");
      console.log("Database opened");
      db.transaction(populateDB, onError);
    } // end else
  }
  catch(err) {
    console.log("Error: " + err);
  }
};
	
var populateDB = function(trans) {
  db.transaction(function(trans) {
	  trans.executeSql(selectOtherTable,[]);
	  db.transaction(showRecords);
	 
	 //trans.executeSql(dropTable,[]);
	  console.log("profile table chosen");
  }); // end of transaction
};

function gaugeRecord(allTimesDriving) {
	//Gauge
	$(".demo").kumaGauge({
  		// dynamic value-up<a href="https://www.jqueryscript.net/time-clock/">date</a>. just for sample.
  		value : Math.floor((allTimesDriving * 100) / 7200),
		// The radius of the arc
		radius : 80, 

		// The padding on the top and bottom of the gauge
		paddingX : 40, 

		// The padding on the left and right of the gauge
		paddingY : 40,  

		// The width of the gauge itseld
		gaugeWidth : 30, 

		// The fill of the gauge, this can be a solid color or a gradient
		fill : "#ff5252", 

		// The fill of the gauge background, this can be a solid color or a gradient
		gaugeBackground : '#f4f4f4', 

		// The fill of the canvas, this can be a solid color or a gradient
		background : '#fff', 

		// Show or hide the needle, 
		// if true the value label shows half of the range
		// if false the value label shows the value
		showNeedle : false, 

		// The speed of the animation in miliseconds
		animationSpeed : 700, 

		// The minimum value of the gauge
		min : 0,

		// The maximum value of the gauge
		max : 100, 

		// The actual value of the gauge
		//value : 80, 

		// The label that indicates the value
		valueLabel : {

		  // show or hide this label
		  display : true, 

		  // The font family of this label
		  fontFamily : 'Arial', 

		  // The font color of this label
		  fontColor : '#000', 

		  // Integer of The font size of this label (without px)
		  fontSize : 20, 

		  // The font weight of this label
		  fontWeight : 'normal',
		},

		title : {

		  // show or hide this label
		  display : false, 

		  // String the value of the title
		  value : '', 

		  // The font family of this label
		  fontFamily : 'Arial', 

		  // The font color of this label
		  fontColor : '#000', 

		  // Integer of The font size of this label (without px)
		  fontSize : 20, 

		   // The font weight of this label
		  fontWeight : 'normal',
		},
		label : {
		  // show or hide this label
		  display : false, 
		}
	});
}
var showRecords = function() {
	db.transaction(function(trans){
		console.log("in showRecords")
		
		trans.executeSql("SELECT * FROM tblProfile;",[], function(trans, result) {
		 //console.log(result);
		  	if(result.rows.length == 0) {
				console.log("in modal2")
				//Modal
				$("#modal1").modal('open');
		 	} else {
				trans.executeSql("SELECT * FROM tblSession;",[], function(trans, result) {
					var output = "";
					console.log("in output");
			 		var noOfRecs = result.rows.length;
					for(var i = 0; i < noOfRecs; i++) {
						var row = result.rows.item(i);
						var id = row['fldLogNo'];
						output += "<div class='col s12 m7 cards'>";
						output += "<a href='html/sessions.html?ID=" + row['fldLogNo'] + "'>";
	  					output += "<div class='card horizontal'>";
			  			output += "<div class='card-stacked'>";
						output += "<div class='card-content'>";
				 		output += "<span class='card-title'><strong>Session " + row['fldLogNo'] + "</strong></span>";
						output += "<div class='card_icon'><i class='material-icons left'>event</i> " + row['fldDate'] + " </div>";
						output += "<div class='card_icon'><i class='material-icons left'>people</i>Supervisor: " + row['fldSupervisorName'] + " </div>";
						//console.log(output);
						console.log(row['fldDrivingTime']);
						console.log(row['fldLogNo'] + " Will go in if ");
						console.log(trans.executeSql("SELECT fldDrivingTime FROM tblSession;"));
						if(row['fldDrivingTime'] == null) {
							console.log("no values");
							output += "<p>This session is not finished yet - Click to edit it</p>";
							//console.log(output);
						} else {
							//var drivingTime = row['fldStartTime'] - row['fldFinishTime'];
							//console.log(drivingTime);
							console.log("in values");
							output += "<div class='card_icon'><i class='material-icons left'>access_time</i>" + row['fldDrivingTime'].substr(0,2) + " minutes</div>";
							output += "<div class='card_icon'><i class='material-icons left'>brightness_4</i>" + row['fldLight'] + "</div>";
							//console.log(output);
						}
						output += "</div></div></div></a></div>";
					}
					$("#cardSession").append(output);
				});
		 	}
	  	});
	});
}

var insertRecord = function() {
  console.log("In insertRecord");

  var newName = $("#txtName").val();
  var newBirthDate = $("#birthDate").val();
  var newLicenceNo = $("#licenceNo").val();
  var newPermitDate = $("#permitDate").val();
  var newPhoneNo = $("#phoneNo").val();

  console.log("New Supervisor: " + newName );
    db.transaction(function(trans) {
      trans.executeSql(insertSQL, [newLicenceNo, newName, newBirthDate, newPermitDate, newPhoneNo], onError);
    });
	location.reload();
	
	$(".msg").html(newName + " " + newLicenceNo + " " + newPhoneNo + " added");
    clearTxt();
    return true;
}
	
var onError = function(err) {
	var str = "";
	switch(err.code)	{
		case	0:  str += "Non database error: " + err.message;
					break;
		case	1:	str += "Some database error: " + err.message;
					break;
		case	2:	str += "Wrong database version: " + err.message;
					break;
		case	3:	str += "Data set too large to return from query: " + err.message;
					break;
		case	4: 	str += "Storage limit exceeded: " + err.message;
					break;
		case	5:	str += "Lock contension error: " + err.message;
					break;
		case	6:	str += "Constraint failure: " + err.message;
					break;
		default	:	str += "Error: " + err.code + " " + err.message;
					break;
	}
	console.log(str);
}

var clearTxt = function clearTxt() {
  setTimeout(function() { $(".msg").html(""); }, 1000);
}
</script>
</head>
<body> 

<div class="pages" id="page" data-theme="a" >
  <nav class="navbar">
    <div class="nav-wrapper">
      <a class="brand-logo txtMargin">Home</a>
      <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li><a href="html/profile.html">Profile</a></li>
        <li><a href="html/drivingLog.html">Log Book</a></li>
        <li><a href="html/supervisor.html">Supervisors</a></li>
      </ul>
    </div>
  </nav>
 <ul class="sidenav" id="mobile-demo">
	<li><a href="html/profile.html">Profile</a></li>
    <li><a href="html/drivingLog.html">Log Book</a></li>
    <li><a href="html/supervisor.html">Supervisors</a></li>
 </ul>
<!--Gauge -->
<h5 class="center">Progression</h5>
<div class="js-gauge demo gauge center"></div>
<hr class="style13">

<!-- Modal1 Structure -->
<div id="modal1" class="modal">
	<div class="modal-content">
			<span class="card-title">Supervisor</span>
				<div class="row">
					<form class="col s12" id="addSupervisor" method="get">
						  <div class="row">
								<div class="input-field col s12">
							  		<input id="txtName" type="text" class="validate" >
							  		<label for="txtName">Name</label>
							  		<p class="msg"></p>
								</div>
						  	</div>
						  	<div class="row">
								<div class="input-field col s12">
									<input id="birthDate" type="text" class="datepicker">
									<label for="birthDate">Birthdate</label>
									<p class="msg"></p>
								</div>
							</div>
							<div class="row">
								<div class="input-field col s12">
								  <input id="licenceNo" type="text" class="validate">
								  <label for="licenceNo">Licence Number</label>
								  <p class="msg"></p>
								</div>
							</div>
							<div class="row">
								<div class="input-field col s12">
									<input id="permitDate" type="text" class="datepicker">
									<label for="permitDate">Permit Date</label>
									<p class="msg"></p>
								</div>
							</div>
							<div class="row">
								<div class="input-field col s12">
									<input id="phoneNo" type="text" class="validate">
									<label for="phoneNo">Phone Number</label>
									<p class="msg"></p>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="col s12">
					<button class="waves-effect waves-light btn modalBtn" type="reset" id="resetButton">Cancel</button>
					<button class="btn waves-effect waves-light modalBtn right red accent-2" type="submit" name="action"  id="saveProfile">Save
						<i class="material-icons right">send</i>
					</button>
  				</div> 
			</div>
		</div>
<!--Cards-->
<div id="cardSession">
	
</div>
<!--	<div class="col s12 m7 cards">-->
	<div class="fixed-action-btn">
	  <a class="btn-floating btn-large red marginButton">
		<i class=" large material-icons">mode_edit</i>
	  </a>
	  <ul>
		<li><a class="btn-floating green btn tooltipped" data-position="left" data-tooltip="Filter"><i class="material-icons">filter_list</i></a></li>
		<li><a class="btn-floating blue btn tooltipped" data-position="left" data-tooltip="Add" href="html/drivingLog.html"><i class="material-icons">add</i></a></li>
	  </ul>
	</div>	
<!--</div>-->
</body>
</html>